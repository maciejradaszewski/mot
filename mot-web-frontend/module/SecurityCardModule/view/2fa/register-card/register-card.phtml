<?php

use Dvsa\Mot\Frontend\SecurityCardModule\CardActivation\ViewModel\RegisterCardViewModel;

/**
 * @var RegisterCardViewModel $viewModel
 */

$this->layout('layout/layout-govuk.phtml');
$this->layout()->setVariable('pageTitle', 'Activate your security card');

$gtmData = $viewModel->getGtmData();
if (!empty($gtmData)) {
    foreach ($gtmData as $gtmDatum) {
        $this->gtmDataLayer($gtmDatum);
    }
}

$gtmTitle = 'User - Activate Security Card';

if ($viewModel->isInvalidSerialNumber()) {
    $this->gtmDataLayer(['event' => 'activate-card-fail', 'reason' => 'invalid-serial-number', 'title' => $gtmTitle]);
}

if ($viewModel->isPinMismatch()) {
    $this->gtmDataLayer(['event' => 'activate-card-fail', 'reason' => 'wrong-serial-number-or-pin', 'title' => $gtmTitle]);
}

if ($viewModel->isCardAlreadyRegistered()) {
    $this->gtmDataLayer(['event' => 'activate-card-fail', 'reason' => 'already-activated-serial-number', 'title' => $gtmTitle]);
}

?>

<div class="grid-row">
    <div class="column-two-thirds">
        <p class="lede">Activate your new card using its serial number and a new PIN. This will take 2 minutes.</p>
        <p>
        </p>
        <details role="group">
            <summary role="button" aria-controls="details-content-0" aria-expanded="false" tabindex="0">
                <span class="summary">Where to find the serial number and PIN</span>
            </summary>
            <div class="panel panel-indent" id="details-content-0" aria-hidden="true">
                <p>The serial number contains 8 digits printed in the upper-right corner on the back of your security
                    card.</p>
                <img src="/assets/images/register-new-card-serial.png" width="505" height="135">

                <p>The security card PIN can be generated by pressing the button in the lower right corner on the front
                    of the card. The security card PIN contains 6 digits.</p>
                <img src="/assets/images/register-new-card-pin.png" width="516" height="135">
            </div>
        </details>
        <p></p>

        <div class="">
            <?php echo $this->partial('zendFormErrorMessages', ['form' => $viewModel->getForm()]); ?>
            <?php
            if ($viewModel->isPinMismatch() || $viewModel->isCardAlreadyRegistered()) :?>
                <div class="message--failure">
                    <p>The was a problem with your serial number or PIN.</p>

                    <p>Try the following. Check your serial number is correct. Generate and enter a new PIN.</p>
                </div>
            <?php endif; ?>

            <form action="<?php echo $this->url('register-card') ?>" method="POST" autocomplete="off">
                <?php echo $this->csrfToken(); ?>
                <fieldset>
                    <?php
                    echo $this->partial(
                        'partial/gds/form/control',
                        [
                            'element' => $viewModel->getForm()->getSerialNumberField()
                        ]
                    );
                    echo $this->partial(
                        'partial/gds/form/control',
                        [
                            'element' => $viewModel->getForm()->getPinField()
                        ]
                    );
                    ?>
                </fieldset>
                <nav class="content-navigation">
                    <input id="activate_cta" type="submit" value="Activate your security card" class="button">
                    <ul class="content-navigation__secondary">
                        <li><?php echo $this->partial($viewModel->getSkipCtaTemplate()); ?></li>
                    </ul>
                </nav>
            </form>
        </div>
    </div>
